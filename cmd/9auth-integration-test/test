#!/usr/bin/env bash
set -e

nix build .#9auth-debug .#9pfs-debug .#9auth-integration-test-debug

testdir=$(mktemp -d)
trap "rm -rf $testdir" EXIT

mkdir -p "$testdir/var/lib/9auth"
mkdir -p "$testdir/var/run"
mkdir -p "$testdir/fs-root"

echo "Test file 1" > "$testdir/fs-root/test1.txt"
echo "Test file 2" > "$testdir/fs-root/test2.txt"
mkdir -p "$testdir/fs-root/testdir"
echo "Test file 3" > "$testdir/fs-root/testdir/test3.txt"

export HOME="$testdir"
auth_socket="$testdir/var/run/9auth"
auth_keys="$testdir/var/lib/9auth/keys"
fs_socket="$testdir/var/run/9pfs"

./result/bin/9auth --socket-path="$auth_socket" --keys-path="$auth_keys" &
auth_pid=$!
trap "kill $auth_pid 2>/dev/null || true; rm -rf $testdir" EXIT
sleep 2

./result-1/bin/9pfs --root="$testdir/fs-root" --require-auth --auth-server=unix!"$auth_socket" unix!"$fs_socket" &
fs_pid=$!
trap "kill $fs_pid $auth_pid 2>/dev/null || true; rm -rf $testdir" EXIT
sleep 2

./result-2/bin/9auth-integration-test unix!"$auth_socket" unix!"$fs_socket" 2>&1 | tee test_output.txt || true

failed_count=$(grep -oP '\d+(?= failed)' test_output.txt || echo "0")
passed_count=$(grep -oP '\d+(?= passed)' test_output.txt || echo "0")

kill $fs_pid $auth_pid 2>/dev/null || true
wait $fs_pid $auth_pid 2>/dev/null || true

if [ "$failed_count" != "0" ]; then
  echo "[ERROR] $failed_count tests failed"
  exit 1
fi

if [ "$passed_count" = "0" ]; then
  echo "[ERROR] no tests ran"
  exit 1
fi

echo "[$passed_count tests passed]"
